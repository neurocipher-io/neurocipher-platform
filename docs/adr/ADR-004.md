id: ADR-004
title: CI CD and Environments
owner: DevEx
status: Accepted
last_reviewed: 2025-10-23

ADR-004 CI CD and Environments

  

  

- Status: Accepted
- Date: 2025-10-23
- Owners: DevEx

  

  

  

Context

  

  

We need safe, repeatable releases with policy checks. No long-lived AWS keys. Preview stacks speed review.

  

  

Decision

  

  

Use GitHub Actions with OIDC to assume AWS roles. Terraform with Terragrunt for IaC. Ephemeral preview per PR. Gated promotion to stg and prod.

  

Pipeline order:

  

1. Lint, type check, unit tests
2. Contract diff and schema validation
3. Build images, SBOM, Trivy and CodeQL
4. Deploy preview stack, run e2e
5. Manual gate to stg, run load and relevance
6. Manual approval to prod, tag and record provenance

  

  

  

Alternatives

  

  

1. Self-hosted runners only
2. AWS CodePipeline
3. Direct apply from laptops

  

  

Rejected due to cost, complexity, or risk.

  

  

Consequences

  

  

- No stored cloud secrets in CI
- Consistent infra across envs
- Extra runtime for previews

  

  

  

Policies

  

  

- Protected main. Feature branches via PR
- Tags vX.Y.Z trigger prod release workflow
- Rollback via versioned Terraform state and image pin

## Acceptance Criteria

- GitHub Actions workflows implement the pipeline order described in this ADR (lint/typecheck/tests → contract diff/schema validation → image build/SBOM/security scans → preview deploy + e2e → gated stg/prod promotion).
- OIDC is used to assume AWS roles from CI; no long-lived cloud credentials are stored in GitHub or the repository.
- Environment definitions under `infra/envs/` are managed via Terraform/Terragrunt and kept consistent across dev, stg, and prod.
- Preview environments are created per PR for in-scope services, and e2e tests are executed against them before promotion.
- Release policies (protected main, tag-driven prod releases, and rollback procedures) are enforced in CI/CD and documented in OPS-001/CI/CL-00x.

  

  

  

Links

  

  

- .github/workflows/*
- infra/envs/*
- SECURITY.md
- 