openapi: 3.1.0
info:
  title: Neurocipher Data Pipeline API
  version: "1.0.0"
  description: >
    REST interface for ingest, query, admin, and security-action operations.
    All business endpoints (excluding `/health`) require `Tenant-Id`, `Correlation-Id`, and authenticated callers (AWS SigV4 or JWT).
servers:
  - url: https://api.neurocipher.io/v1
    description: Production
  - url: https://stg-api.neurocipher.io/v1
    description: Staging
  - url: http://localhost:8000/v1
    description: Local development
tags:
  - name: ingest
    description: Ingestion endpoints for raw events and documents.
  - name: query
    description: Query endpoints for searching normalized content.
  - name: admin
    description: Administrative endpoints for reindexing and maintenance.
  - name: security
    description: Security Engine integration endpoints for actions and status.
  - name: health
    description: Liveness and dependency health checks.
components:
  securitySchemes:
    SigV4Auth:
      type: apiKey
      name: Authorization
      in: header
      description: AWS Signature Version 4 signed request
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  parameters:
    TenantId:
      name: Tenant-Id
      in: header
      required: true
      schema:
        type: string
      description: Logical tenant identifier (ULID)
    CorrelationId:
      name: Correlation-Id
      in: header
      required: false
      schema:
        type: string
      description: ULID; generated by the API if absent
    IdempotencyKey:
      name: Idempotency-Key
      in: header
      required: true
      schema:
        type: string
      description: Required for all mutating requests; ULID or UUID v4
  schemas:
    ErrorResponse:
      type: object
      properties:
        error:
          type: object
          properties:
            code:
              type: string
            message:
              type: string
            correlation_id:
              type: string
            details:
              type: object
          required:
            - code
            - message
    IngestRequest:
      type: object
      required:
        - source
        - content_type
        - data
      properties:
        source:
          type: string
        content_type:
          type: string
        data:
          type: string
          description: Base64 blob or JSON string
        metadata:
          type: object
          additionalProperties: true
    IngestResponse:
      type: object
      properties:
        event_id:
          type: string
        status:
          type: string
          enum: [accepted, queued]
    QueryResponse:
      type: object
      properties:
        query:
          type: string
        top_k:
          type: integer
        mode:
          type: string
          enum: [hybrid, vector, keyword]
        results:
          type: array
          items:
            type: object
            properties:
              doc_id:
                type: string
              score:
                type: number
              title:
                type: string
              snippet:
                type: string
              metadata:
                type: object
                additionalProperties: true
        next_cursor:
          type: string
          nullable: true
          description: Opaque cursor token for fetching the next page of results; null or omitted when there is no next page.
    ReindexRequest:
      type: object
      properties:
        entity_type:
          type: string
        date_range:
          type: object
          properties:
            start:
              type: string
              format: date-time
            end:
              type: string
              format: date-time
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, degraded, failed]
        components:
          type: object
          additionalProperties:
            type: string
    SecurityAction:
      type: object
      required:
        - action_id
        - schema_urn
        - payload
      properties:
        schema_urn:
          type: string
          enum:
            - urn:nc:schema:security:command:cmd.security.quarantine.v1
            - urn:nc:schema:security:command:cmd.security.ticket.create.v1
            - urn:nc:schema:security:command:cmd.security.notify.v1
        action_id:
          type: string
        payload:
          type: object
        ttl_seconds:
          type: integer
          minimum: 60
    SecurityActionResponse:
      type: object
      properties:
        action_id:
          type: string
        status:
          type: string
          enum: [accepted, duplicate]
        status_url:
          type: string
    SecurityActionStatus:
      type: object
      properties:
        action_id:
          type: string
        status_id:
          type: string
        status:
          type: string
          enum: [queued, running, succeeded, failed]
        retriable:
          type: boolean
        observed_at:
          type: string
          format: date-time
        details:
          type: object
  examples:
    IngestExample:
      summary: Example ingest document
      value:
        source: webhook.crm
        content_type: application/json
        data: eyJuYW1lIjoiSmFuZSJ9
        metadata:
          checksum: sha256:abc123
          received_at: 2025-01-20T12:40:00Z
    QueryExample:
      summary: Hybrid query
      value:
        query: "privileged access policy"
        top_k: 5
        mode: hybrid
        results:
          - doc_id: "doc_123"
            score: 0.92
            title: "Privileged access baseline policy"
            snippet: "All privileged accounts must follow baseline controls."
            metadata:
              source: "policy-repo"
              tenant_id: "tn_01HZY3"
        next_cursor: "opaque-cursor-token-01"
    ErrorRateLimitedExample:
      summary: Rate limit exceeded error
      value:
        error:
          code: "RATE_LIMITED"
          message: "Rate limit exceeded. Try again after reset."
          correlation_id: "01J9Z4Q7A6M8T1N9ZK7N1A2B3C"
          details:
            retry_after_seconds: 60
paths:
  /ingest/event:
    post:
      summary: Ingest new event or document
      description: Ingests a new raw event or document into the Neurocipher data pipeline for normalization, enrichment, and downstream embedding.
      tags: [ingest]
      operationId: ingestEvent
      security:
        - SigV4Auth: []
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/TenantId'
        - $ref: '#/components/parameters/CorrelationId'
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IngestRequest'
            examples:
              default:
                $ref: '#/components/examples/IngestExample'
      responses:
        "202":
          description: Event accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IngestResponse'
        "400":
          description: Invalid payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        "429":
          description: Rate limited
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                default:
                  $ref: '#/components/examples/ErrorRateLimitedExample'
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /query:
    get:
      summary: Search normalized documents
      description: Performs hybrid vector and keyword search over normalized documents, applying relevance fusion and optional filters.
      tags: [query]
      operationId: queryDocuments
      security:
        - SigV4Auth: []
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/TenantId'
        - $ref: '#/components/parameters/CorrelationId'
        - in: query
          name: q
          required: true
          schema:
            type: string
        - in: query
          name: filters
          schema:
            type: string
          description: JSON encoded filter expression
        - in: query
          name: top_k
          schema:
            type: integer
            default: 10
        - in: query
          name: mode
          schema:
            type: string
            enum: [hybrid, vector, keyword]
            default: hybrid
      responses:
        "200":
          description: Query results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueryResponse'
              examples:
                default:
                  $ref: '#/components/examples/QueryExample'
        "400":
          description: Invalid query
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        "429":
          description: Rate limited
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /admin/reindex:
    post:
      summary: Reindex normalized documents
      description: Schedules a reindex job over normalized documents for maintenance, backfill, or recovery scenarios.
      tags: [admin]
      operationId: adminReindex
      security:
        - SigV4Auth: []
      parameters:
        - $ref: '#/components/parameters/TenantId'
        - $ref: '#/components/parameters/CorrelationId'
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReindexRequest'
      responses:
        "202":
          description: Reindex job accepted
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        "429":
          description: Rate limited
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /security/actions:
    post:
      summary: Submit security action command
      description: Submits a security action command to the Security Engine, such as quarantine, ticket creation, or notification.
      tags: [security]
      operationId: createSecurityAction
      security:
        - SigV4Auth: []
      parameters:
        - $ref: '#/components/parameters/TenantId'
        - $ref: '#/components/parameters/CorrelationId'
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SecurityAction'
      responses:
        "202":
          description: Command accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SecurityActionResponse'
        "400":
          description: Invalid command payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        "409":
          description: Duplicate action_id detected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SecurityActionResponse'
        "429":
          description: Rate limited
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /security/actions/{id}:
    get:
      summary: Fetch security action status
      description: Retrieves the latest status of a previously submitted security action command.
      tags: [security]
      operationId: getSecurityAction
      security:
        - SigV4Auth: []
      parameters:
        - $ref: '#/components/parameters/TenantId'
        - $ref: '#/components/parameters/CorrelationId'
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Action status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SecurityActionStatus'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        "404":
          description: Action not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /health:
    get:
      summary: Health and dependency check
      description: Returns liveness and dependency health status for the Neurocipher data pipeline API.
      tags: [health]
      operationId: healthCheck
      parameters:
        - $ref: '#/components/parameters/CorrelationId'
      responses:
        "200":
          description: Healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
        "500":
          description: Unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
